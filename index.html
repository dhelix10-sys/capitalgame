import React, { useState, useEffect } from 'react';
import { Trophy, RefreshCcw, CheckCircle2, XCircle, Globe2, ArrowRight, Heart } from 'lucide-react';

// 국가 및 수도 데이터셋
const COUNTRY_DATA = [
  { country: "대한민국", capital: "서울" },
  { country: "일본", capital: "도쿄" },
  { country: "중국", capital: "베이징" },
  { country: "미국", capital: "워싱턴 D.C." },
  { country: "프랑스", capital: "파리" },
  { country: "영국", capital: "런던" },
  { country: "독일", capital: "베를린" },
  { country: "이탈리아", capital: "로마" },
  { country: "캐나다", capital: "오타와" },
  { country: "브라질", capital: "브라질리아" },
  { country: "호주", capital: "캔버라" },
  { country: "러시아", capital: "모스크바" },
  { country: "인도", capital: "뉴델리" },
  { country: "이집트", capital: "카이로" },
  { country: "스페인", capital: "마드리드" },
  { country: "멕시코", capital: "멕시코시티" },
  { country: "베트남", capital: "하노이" },
  { country: "태국", capital: "방콕" },
  { country: "그리스", capital: "아테네" },
  { country: "터키", capital: "앙카라" }
];

const App = () => {
  const [gameState, setGameState] = useState('START'); // START, PLAYING, FINISHED
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [isCorrect, setIsCorrect] = useState(null);
  const [shuffledQuestions, setShuffledQuestions] = useState([]);
  const [options, setOptions] = useState([]);

  // 게임 초기화 및 문제 섞기
  const startGame = () => {
    const shuffled = [...COUNTRY_DATA].sort(() => Math.random() - 0.5);
    setShuffledQuestions(shuffled);
    setCurrentQuestionIndex(0);
    setScore(0);
    setGameState('PLAYING');
    setSelectedAnswer(null);
    setIsCorrect(null);
  };

  // 현재 문제에 대한 선택지 생성
  useEffect(() => {
    if (gameState === 'PLAYING' && shuffledQuestions.length > 0) {
      const currentQuestion = shuffledQuestions[currentQuestionIndex];
      const otherCapitals = COUNTRY_DATA
        .filter(item => item.capital !== currentQuestion.capital)
        .map(item => item.capital)
        .sort(() => Math.random() - 0.5)
        .slice(0, 3);
      
      const combinedOptions = [...otherCapitals, currentQuestion.capital]
        .sort(() => Math.random() - 0.5);
      
      setOptions(combinedOptions);
      setSelectedAnswer(null);
      setIsCorrect(null);
    }
  }, [currentQuestionIndex, gameState, shuffledQuestions]);

  const handleAnswerSelect = (answer) => {
    if (selectedAnswer !== null) return;

    setSelectedAnswer(answer);
    const correct = answer === shuffledQuestions[currentQuestionIndex].capital;
    setIsCorrect(correct);
    if (correct) setScore(prev => prev + 1);

    setTimeout(() => {
      if (currentQuestionIndex + 1 < shuffledQuestions.length) {
        setCurrentQuestionIndex(prev => prev + 1);
      } else {
        setGameState('FINISHED');
      }
    }, 1200);
  };

  const progressPercentage = shuffledQuestions.length > 0 
    ? ((currentQuestionIndex) / shuffledQuestions.length) * 100 
    : 0;

  return (
    <div className="min-h-screen bg-[#fdfbfb] flex items-center justify-center p-4 font-sans text-slate-700">
      <div className="w-full max-w-md bg-white/80 backdrop-blur-sm rounded-[2.5rem] shadow-2xl overflow-hidden border border-white">
        
        {/* Header - Soft Pastel Indigo/Lavender */}
        <div className="bg-indigo-300 p-8 text-white text-center relative overflow-hidden">
          <div className="absolute -top-4 -right-4 w-24 h-24 bg-white/20 rounded-full blur-2xl"></div>
          <div className="absolute -bottom-4 -left-4 w-20 h-20 bg-purple-200/30 rounded-full blur-xl"></div>
          <Globe2 className="mx-auto mb-2 opacity-90" size={32} />
          <h1 className="text-2xl font-bold tracking-tight drop-shadow-sm">수도 맞추기 퀴즈</h1>
          <p className="text-indigo-50 mt-1 text-sm font-medium opacity-90">지구촌 여행을 시작해볼까요?</p>
        </div>

        <div className="p-8">
          {gameState === 'START' && (
            <div className="text-center py-6">
              <div className="w-24 h-24 bg-rose-50 text-rose-300 rounded-full flex items-center justify-center mx-auto mb-6 transition-transform hover:scale-110">
                <Heart size={48} fill="currentColor" />
              </div>
              <h2 className="text-xl font-bold mb-4 text-slate-600">준비되셨나요?</h2>
              <p className="text-slate-400 mb-8 leading-relaxed text-sm">
                총 {COUNTRY_DATA.length}개의 퀴즈가 기다리고 있어요.<br/>
                부드러운 마음으로 수도를 맞춰보세요!
              </p>
              <button
                onClick={startGame}
                className="w-full bg-indigo-400 hover:bg-indigo-500 text-white font-bold py-4 px-6 rounded-2xl transition-all active:scale-95 flex items-center justify-center gap-2 shadow-lg shadow-indigo-100"
              >
                모험 시작하기 <ArrowRight size={20} />
              </button>
            </div>
          )}

          {gameState === 'PLAYING' && shuffledQuestions.length > 0 && (
            <div>
              {/* Progress - Pastel Mint */}
              <div className="mb-10">
                <div className="flex justify-between items-end mb-2">
                  <span className="text-xs font-bold text-slate-300 uppercase tracking-[0.2em]">PROGRESS</span>
                  <span className="text-sm font-bold text-indigo-300">{currentQuestionIndex + 1} / {shuffledQuestions.length}</span>
                </div>
                <div className="h-3 w-full bg-slate-50 rounded-full overflow-hidden p-0.5 border border-slate-100">
                  <div 
                    className="h-full bg-teal-200 rounded-full transition-all duration-700 ease-out"
                    style={{ width: `${progressPercentage}%` }}
                  />
                </div>
              </div>

              {/* Question */}
              <div className="text-center mb-10">
                <h3 className="text-slate-300 text-[0.65rem] font-black mb-3 uppercase tracking-[0.3em]">WHERE IS THE CAPITAL OF</h3>
                <div className="text-4xl font-black text-slate-600 tracking-tight">
                  {shuffledQuestions[currentQuestionIndex].country}
                </div>
              </div>

              {/* Options - Pastel Tones */}
              <div className="grid grid-cols-1 gap-4">
                {options.map((option, idx) => {
                  let buttonClass = "w-full text-left p-4 rounded-2xl border-2 transition-all flex justify-between items-center group ";
                  let statusIcon = null;

                  if (selectedAnswer === option) {
                    if (isCorrect) {
                      buttonClass += "border-emerald-200 bg-emerald-50 text-emerald-600 shadow-inner";
                      statusIcon = <CheckCircle2 className="text-emerald-400" size={20} />;
                    } else {
                      buttonClass += "border-rose-200 bg-rose-50 text-rose-600 shadow-inner";
                      statusIcon = <XCircle className="text-rose-400" size={20} />;
                    }
                  } else if (selectedAnswer !== null && option === shuffledQuestions[currentQuestionIndex].capital) {
                    buttonClass += "border-emerald-100 bg-emerald-50/30 text-emerald-400";
                    statusIcon = <CheckCircle2 className="text-emerald-200" size={20} />;
                  } else {
                    buttonClass += selectedAnswer === null 
                      ? "border-slate-50 hover:border-indigo-100 hover:bg-indigo-50/30 text-slate-500 hover:text-indigo-400" 
                      : "border-transparent text-slate-200 cursor-not-allowed opacity-50";
                  }

                  return (
                    <button
                      key={idx}
                      onClick={() => handleAnswerSelect(option)}
                      disabled={selectedAnswer !== null}
                      className={buttonClass}
                    >
                      <span className="font-bold text-lg">{option}</span>
                      {statusIcon}
                    </button>
                  );
                })}
              </div>
              
              <div className="mt-10 text-center">
                <span className="px-4 py-2 bg-slate-50 rounded-full text-slate-400 text-[0.7rem] font-bold tracking-widest">
                  SCORE: <span className="text-indigo-300">{score}</span>
                </span>
              </div>
            </div>
          )}

          {gameState === 'FINISHED' && (
            <div className="text-center py-4">
              <div className="relative w-28 h-28 mx-auto mb-8">
                <div className="absolute inset-0 bg-amber-100 rounded-full animate-pulse"></div>
                <div className="relative w-full h-full bg-amber-50 text-amber-300 rounded-full flex items-center justify-center shadow-inner">
                  <Trophy size={56} />
                </div>
              </div>
              
              <h2 className="text-2xl font-black text-slate-600 mb-2 tracking-tight">여행을 마쳤습니다!</h2>
              <p className="text-slate-400 mb-8 text-sm">정말 훌륭한 실력이시네요.</p>
              
              <div className="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-[2rem] p-8 mb-10 flex flex-col items-center justify-center shadow-sm border border-white">
                <div className="text-6xl font-black text-indigo-400 mb-2 drop-shadow-sm">
                  {Math.round((score / COUNTRY_DATA.length) * 100)}<span className="text-2xl ml-1">점</span>
                </div>
                <div className="text-slate-400 font-bold uppercase tracking-[0.2em] text-[0.65rem]">
                  {score} / {COUNTRY_DATA.length} CORRECT ANSWERS
                </div>
              </div>

              <button
                onClick={startGame}
                className="w-full bg-slate-700 hover:bg-slate-800 text-white font-bold py-4 px-6 rounded-2xl transition-all active:scale-95 flex items-center justify-center gap-2 shadow-xl shadow-slate-100"
              >
                <RefreshCcw size={20} /> 다시 여행하기
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default App;